{% extends '_base.html' %}

{% block title %}Edit{% endblock %}

{% block content %}
<a href="{{ url_for('home') }}"><strong>Back</strong></a>

<div class="row">
    <input class="col s6" v-model='name' placeholder="Recipe name"/>
</div>

<p><strong>Ingredients</strong></p>
<ul class="collection">
    <li class="collection-item" v-for='ingredient in ingredients'>
        <div class="row">
            <div class="col s1 input-field">
                <input v-model='ingredient.amount' placeholder="1" />
            </div>
            <div class="col s3 input-field">
                <input v-model='ingredient.unit' placeholder="cup" />
            </div>
            <div class="col s3 input-field">
                <input v-model='ingredient.name' placeholder="flour" />
            </div>
            <div class="col s3 input-field">
                <input v-model='ingredient.preparation' placeholder="chopped" />
            </div>
        </div>
    </li>
</ul>
<a class="waves-effect waves-light btn" @click='addIngredient'>Add Ingredient</a>

<p><strong>Steps</strong></p>
<ul class="collection">
    <li v-for='step in steps'>
        <div class="collection-item">
            <textarea class="materialize-textarea" v-model='step.description'></textarea>
        </div>
    </li>
</ul>
<a class="waves-effect waves-light btn" @click='addStep'>Add Step</a>
<hr>
<a class="waves-effect waves-light btn" @click='saveRecipe'>Save Recipe</a>
{% endblock %}

{% block pre_app_script %}
    var ingredient_template = {
        amount: null,
        unit: '',
        name: '',
        preparation: ''
    }
    var step_template = {
        description: ''
    }
{% endblock %}

{% block app_data %}
    recipe_id: {{ recipe.id if recipe else 0 }},
    name: '{{ recipe.name if recipe else '' }}',
    ingredients: [
        {% if recipe %}
            {% for measure in recipe.ingredients %}
                {
                    amount: {{ measure.amount }},
                    unit: "{{ measure.unit or 'null' }}",
                    name: "{{ measure.ingredient.name }}",
                    preparation: "{{ measure.preparation or '' }}"
                },
            {% endfor %}
        {% else %}
            Object.assign({}, ingredient_template)
        {% endif %}
    ],
    steps: [
        {% if recipe %}
            {% for step in recipe.steps %}
                {
                    description: "{{ step.description }}"
                },
            {% endfor %}
        {% else %}
            Object.assign({}, step_template)
        {% endif %}
    ]
{% endblock %}

{% block app_methods %}
    addIngredient: function() {
        this.ingredients.push(Object.assign({}, ingredient_template))
    },
    addStep: function() {
        this.steps.push(Object.assign({}, step_template))
    },
    saveRecipe: function() {
        axios.post(
            "{{ url_for("save_recipe") }}",
            {
                recipe_id: this.recipe_id,
                name: this.name,
                ingredients: this.ingredients,
                steps: this.steps.map(step => step.description)
            }
        )
    }
{% endblock %}
